*          DATA SET CBT1791    AT LEVEL 001 AS OF 12/20/87
         TITLE 'LINKLIST - COMMAND TO SHOW THE SYSTEM LINKLIST'         00001
**********************************************************************  00002
***                                                                ***  00003
***  LOCAL MACROS                                                  ***  00004
***                                                                ***  00005
**********************************************************************  00006
         MACRO                                                          00007
         IHALLT                       , MAP OF LLT  DSECT=LLT           00008
.*                                                                      00009
.*   The LLT is described in the Debugging Handbook, but the            00010
.*   IHALLT macro is nowhere to be found.  This is my best guess        00011
.*   at what it must look like, based on the handbook.                  00012
.*                                                                      00013
LLT      DSECT                                                          00014
LLTHEAD  DS    0CL8                     TABLE HEADER                    00015
LLTID    DS    CL4                        TABLE ID 'LLT '               00016
LLTCOUNT DS    F                          NUMBER OF ENTRIES IN TABLE    00017
LLTENTRY DS    0CL45                    ENTRY IN TABLE                  00018
LLTDSLTH DS    XL1                        LENGTH OF DATASET NAME        00019
LLTDSN   DS    CL44                       DATASET NAME                  00020
         MEND                                                           00021
*                                                                       00022
         EJECT                                                          00023
         PRINT NOGEN                                                    00024
**********************************************************************  00025
***                                                                ***  00026
***                   LINKLIST                                     ***  00027
***                                                                ***  00028
***   This is a TSO command to show the system id and the          ***  00029
***   LINKLIST for the running system.                             ***  00030
***                                                                ***  00031
***   Syntax -                                                     ***  00032
***                                                                ***  00033
***       LINKLIST   SYSID/ID       NUM                            ***  00034
***       LL         NOSYSID/NOID   NONUM                          ***  00035
***                                                                ***  00036
***       Required - none                                          ***  00037
***                                                                ***  00038
***       Defaults - SYSID, NUM                                    ***  00039
***                                                                ***  00040
***                                                                ***  00041
***   ATTRIBUTES - REENTERABLE, REUSABLE, REFRESHABLE              ***  00042
***                                                                ***  00043
**********************************************************************  00044
*                                                                       00045
         EJECT                                                          00046
**********************************************************************  00047
***                                                                ***  00048
***  Author -                                                      ***  00049
***                                                                ***  00050
***    Credit -                                                    ***  00051
***      I attribute the idea for the basic approach used in this  ***  00052
***      code to Paul L. Sullivan, who published the idea in the   ***  00053
***      December, 1987, issue of Technical Support magazine.      ***  00054
***                                                                ***  00055
***      I took Paul's idea and incorporated it into a skeleton of ***  00056
***      a "real" TSO command which I developed some time ago for  ***  00057
***      presentations at meetings of SHARE, Inc., entitled "How   ***  00058
***      to Write a TSO Command."  An ESTAE exit is part of this   ***  00059
***      skeleton.                                                 ***  00060
***                                                                ***  00061
***    Initial Enhancements -                                      ***  00062
***      I used mapping macros for all the data areas needed by    ***  00063
***      the program.  This includes by best guess of what the     ***  00064
***      IHALLT macro would look like, using the same data names   ***  00065
***      as appear in the Debugging Handbook.  Also, I converted   ***  00066
***      Paul's TPUT I/O to PUTLINE so that SYSOUT trapping        ***  00067
***      available in CLISTs could be used to hold the output,     ***  00068
***      and so that I/O would occur in batch.  I also added the   ***  00069
***      command operands and the code to go get the SMF System    ***  00070
***      ID for the output display.  Finally, I ensured that all   ***  00071
***      code would now be reenterable.  A HELP document is        ***  00072
***      included in this source code.                             ***  00073
***                                                                ***  00074
***    Chuck Hoffman                                               ***  00075
***    Supervisor, IBM Systems Programming                         ***  00076
***    GTE Laboratories - Technical Computation Center             ***  00077
***    40 Sylvan Road                                              ***  00078
***    Waltham, MA  02254                                          ***  00079
***                            (w) 617/466-2131                    ***  00080
***                            (h) 617/551-0185                    ***  00081
***                                                                ***  00082
**********************************************************************  00083
*                                                                       00084
         EJECT                                                          00085
**********************************************************************  00086
***                                                                ***  00087
***                   HELP TEXT                                    ***  00088
***                                                                ***  00089
***  )F FUNCTION -                                                 ***  00090
***    The LINKLIST command is used to display the SMF system id,  ***  00091
***    and the names of libraries on the current LNKLSTxx.         ***  00092
***                                                                ***  00093
***  )X SYNTAX -                                                   ***  00094
***      LINKLIST   SYSID/ID       NUM                             ***  00095
***      LL         NOSYSID/NOID   NONUM                           ***  00096
***                                                                ***  00097
***      Required - none                                           ***  00098
***                                                                ***  00099
***      Defaults - SYSID, NUM                                     ***  00100
***                                                                ***  00101
***  )O OPERANDS -                                                 ***  00102
***                                                                ***  00103
***  ))SYSID   - Show the SMF system id in a header line.          ***  00104
***  ))ID      - Show the SMF system id in a header line.          ***  00105
***                                                                ***  00106
***  ))NOSYSID - Do not show the SMF system id in a header line.   ***  00107
***  ))NOID    - Do not show the SMF system id in a header line.   ***  00108
***                                                                ***  00109
***  ))NUM     - Show a sequence number before each library name.  ***  00110
***  ))NONUM   - Do not show a sequence number before each library ***  00111
***              name.                                             ***  00112
***                                                                ***  00113
***  ))EXAMPLE -                                                   ***  00114
***                                                                ***  00115
***      READY                                                     ***  00116
***      linklist                                                  ***  00117
***                                                                ***  00118
***      ---- BSYS LINK LIST ----                                  ***  00119
***        0  SYS1.LINKLIB                                         ***  00120
***        1  SYS1.CMDLIB                                          ***  00121
***        2  SYS1.FORTLIB                                         ***  00122
***        3  SYS1.COBLIB                                          ***  00123
***                                                                ***  00124
***      READY                                                     ***  00125
***                                                                ***  00126
***  )S SUBCOMMANDS -                                              ***  00127
***    The LINKLIST command has no subcommands.                    ***  00128
***                                                                ***  00129
**********************************************************************  00130
*                                                                       00131
         EJECT                                                          00132
**********************************************************************  00133
***                                                                ***  00134
***   THE FOLLOWING COMMAND WILL PRODUCE PDE'S AS SHOWN.           ***  00135
***                                                                ***  00136
***   TEST AT LABEL PAEND.  EQUATE PARMPDL WITH 9R%.               ***  00137
***                                                                ***  00138
***          LINKLIST  NOSYSID                                     ***  00139
***                                                                ***  00140
***                                                                ***  00141
***     KEYSYSID                                                   ***  00142
***       +-----+                                                  ***  00143
***       |00 02|                                                  ***  00144
***       +-----+                                                  ***  00145
***                                                                ***  00146
***     KEYNUM                                                     ***  00147
***       +-----+                                                  ***  00148
***       |00 01|                                                  ***  00149
***       +-----+                                                  ***  00150
***                                                                ***  00151
**********************************************************************  00152
         EJECT                                                          00153
**********************************************************************  00154
***                                                                ***  00155
***   PROLOG                                                       ***  00156
***                                                                ***  00157
***     1.  Linkage conventions and addressability.                ***  00158
***     2.  Clear the completion code                              ***  00159
***     3.  Save the pointer to the CPPL.                          ***  00160
***                                                                ***  00161
**********************************************************************  00162
*                                                                       00163
LINKLIST CSECT                                                          00164
LINKLIST AMODE 24                                                       00165
LINKLIST RMODE 24                                                       00166
         STM   R14,R12,12(R13)          SAVE INTO CALLERS S.A.          00167
         B     BASE-LINKLIST(0,R15)     BRANCH TO AROUND EYECATCHER     00168
         DC    AL1(L'NAME)                LENGTH OF NAME                00169
NAME     DC    C'LINKLIST'                MODULE NAME                   00170
         DC    C' &SYSDATE &SYSTIME '     DD.MM.YY HH.MM                00171
BASE     LR    RBASE,R15                RBASE IS BASE REGISTER          00172
         USING LINKLIST,RBASE             TELL ASSEMBLER                00173
         GETMAIN  R,LV=WORKDLEN,SP=0    GET AREA FOR MYSAVE AND WORK    00174
         ST    R13,4(0,R1)              CALLERS S.A. ADDR TO MY S.A.    00175
         ST    R1,8(0,R13)              MY S.A. ADDR TO CALLERS S.A.    00176
         LM    R15,R1,16(R13)           RESTORE REGS USED BY GETMAIN    00177
         L     R13,8(0,R13)             R13 POINTS TO MY S.A.           00178
         USING WORKD,R13                  TELL ASSEMBLER                00179
*                                                                       00180
         USING PARMPDL,R9               ADDRESSABILITY OF PDE LIST      00181
*                                                                       00182
         USING LLT,R8                   ADDRESSABILITY OF LINKLIST TBL  00183
*                                                                       00184
         XC    COMPCODE,COMPCODE        CLEAR COMPLETION CODE TO ZERO   00185
         ST    R1,CPPLPTR               SAVE CPPL POINTER               00186
*                                                                       00187
         B     MAINLINE                                                 00188
*                                                                       00189
         EJECT                                                          00190
**********************************************************************  00191
***                                                                ***  00192
***   MAIN LINE ROUTINE                                            ***  00193
***                                                                ***  00194
**********************************************************************  00195
*                                                                       00196
MAINLINE BAL   RBAL,ABEND               SET UP ABEND EXIT               00197
         BAL   RBAL,PPLSETUP            SET UP PARSE PARM LIST          00198
*                                                                       00199
MAPARSE  BAL   RBAL,PARSE               PARSE THE INPUT PARAMETERS      00200
         CLC   RETCDE(4),F0             IF RETURN CODE IS BAD           00201
         BE    *+14                     THEN                            00202
         MVC   COMPCODE(4),F12            SET RETURN CODE TO 12         00203
         B     ENDING                     AND GO TO ENDING              00204
*                                                                       00205
MALOCATE BAL   RBAL,LOCATE              LOCATE THE DATA AREAS           00206
         CLC   RETCDE(4),F0             IF RETURN CODE IS BAD           00207
         BE    *+14                     THEN                            00208
         MVC   COMPCODE(4),F12            SET RETURN CODE TO 12         00209
         B     ENDING                     AND GO TO ENDING              00210
*                                                                       00211
MAPRINT  BAL   RBAL,PRINT               PRINT THE OUTPUT                00212
         CLC   RETCDE(4),F0             IF RETURN CODE IS BAD           00213
         BE    *+14                     THEN                            00214
         MVC   COMPCODE(4),F12            SET RETURN CODE TO 12         00215
         B     ENDING                     AND GO TO ENDING              00216
*                                                                       00217
         B     ENDING                   BRANCH TO ENDING                00218
         EJECT                                                          00219
**********************************************************************  00220
***                                                                ***  00221
***   EPILOG                                                       ***  00222
***                                                                ***  00223
***     1.  Release storage used by IKJPARS.                       ***  00224
***     2.  Linkage conventions.                                   ***  00225
***                                                                ***  00226
**********************************************************************  00227
ENDING04 LA       R15,X'04'(0,0)          RETURN CODE TO R15            00228
         ST       R15,COMPCODE              SAVE IN COMPLETION CODE     00229
*                                                                       00230
ENDING   LA       R2,MYPPL+(PPLANS-PPL)   ADDRESS OF PTR TO PDL         00231
         L        R2,0(0,R2)              R4 POINTS TO PDL              00232
         IKJRLSA  (R2)                    FREE STORAGE OF PDL           00233
*                                                                       00234
ENDABEND ESTAE    0                       CANCEL THE ABEND EXIT         00235
*                                                                       00236
         L        R14,COMPCODE            R14 TEMPORARILY HAS COMP CODE 00237
         LR       R15,R13                 R15 HAS MY SAVE AREA ADDRESS  00238
         L        R13,4(0,R13)            R13 RESTORE, PNT TO CALLER SA 00239
         FREEMAIN R,LV=WORKDLEN,SP=0,A=(R15)  FREE MYSAVE,COMPCODE,ETC  00240
         LM       R0,R12,20(R13)          R0-R12 RESTORE FROM CALLER SA 00241
         LR       R15,R14                 R15 GETS COMP CODE            00242
         L        R14,12(0,R13)           R14 RESTORE FROM CALLERS S.A. 00243
         MVI      12(R13),X'FF'           SIGNAL MODULE COMPLETE        00244
         BR       R14                     RETURN                        00245
*                                                                       00246
         EJECT                                                          00247
**********************************************************************  00248
***                                                                ***  00249
***           SET UP EXIT FOR ABENDS                               ***  00250
***                                                                ***  00251
***  Use ESTAE to set up an environment to trap ABENDs.            ***  00252
***                                                                ***  00253
***  1.  The exit is ESTXIT.                                       ***  00254
***  2.  The return point is at label ENDING04 in main routine.    ***  00255
***  3.  The parm list passed to the exit will be:                 ***  00256
***                                                                ***  00257
***         ESTUPL                                                 ***  00258
***         +-----------+                                          ***  00259
***         |           |==> Return point                          ***  00260
***         +-----------+                                          ***  00261
***         |           |==> User work area                        ***  00262
***         +-----------+    +-----------+                         ***  00263
***                          | Register  |                         ***  00264
***                          | save area |                         ***  00265
***                         ---         ---                        ***  00266
***                         ---         ---                        ***  00267
***                          |           |                         ***  00268
***                          +-----------+                         ***  00269
***                          | Other data|                         ***  00270
***                          +-----------+                         ***  00271
***                                                                ***  00272
**********************************************************************  00273
ABEND    ST    RBAL,ABRBALSV            SAVE RETURN ADDRESS             00274
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00275
*                                                                       00276
         MVC   ESTAEL(ESTAELLN),ESTAED  INITIALIZE ESTAE PARM LIST      00277
         LA    R15,ENDING04             ADDRESS OF RETURN POINT         00278
         ST    R15,ESTUPL                 INTO USER PARM LIST           00279
         LA    R15,ESTUWK               ADDRESS OF USER WORK AREA       00280
         ST    R15,ESTUPL+4               INTO USER PARM LIST           00281
         LA    R4,ESTUPL                R4 HAS ADDRESS OF USER PARM LST 00282
         L     R5,VESTXIT               R5 HAS ADDRESS OF ESTAE EXIT    00283
*                                                                       00284
ABESTAE  ESTAE (R5),PARAM=(R4),MF=(E,ESTAEL)  EXECUTE ESTAE             00285
*                                                                       00286
ABENDEND L     RBAL,ABRBALSV            RESTORE RETURN ADDRESS          00287
         BR    RBAL                     RETURN                          00288
         EJECT                                                          00289
**********************************************************************  00290
***                                                                ***  00291
***        CREATE PARSE PARAMETER LIST AND I/O PARM LIST           ***  00292
***                                                                ***  00293
***        PARSE                                                   ***  00294
***          1.  Copy addresses of UPT, ECT and CBUF from CPPL.    ***  00295
***          2.  Add addresses of own ECB, ANS and UWA, and        ***  00296
***              address of PCE List (PCL) created by macros.      ***  00297
***                                                                ***  00298
***        I/O                                                     ***  00299
***          1.  Copy addresses of UPD and ECT from CPPL.          ***  00300
***          2.  Add address of own I/O ECB.                       ***  00301
***          3.  Zero the IOPLIOPB pointer.  This will point to    ***  00302
***              the parm block for the appropriate I/O routine.   ***  00303
***              It will be filled in by the execute form of the   ***  00304
***              STACK, GETLINE, PUTLINE or PUTGET macro when      ***  00305
***              executed.                                         ***  00306
**********************************************************************  00307
PPLSETUP ST    RBAL,PPRBALSV            SAVE RETURN ADDRESS             00308
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00309
*                                                                       00310
         L     R4,CPPLPTR               ADDRESS OF CMD PROC PARM LIST   00311
         USING CPPL,R4                    ADDRESSABILITY                00312
         LA    R6,MYPPL                 ADDRESS OF MY PARSE PARM LIST   00313
         USING PPL,R6                     ADDRESSABILITY                00314
*                                                                       00315
         MVC   PPLUPT(4),CPPLUPT        UPT  (CPPL)                     00316
         MVC   PPLECT(4),CPPLECT        ECT  (CPPL)                     00317
         LA    R5,MYECB                                                 00318
         ST    R5,PPLECB                ECB  (MINE)                     00319
         MVC   PPLPCL(4),VPARMPCL       PCL  (CSECT)                    00320
         LA    R5,MYANS                                                 00321
         ST    R5,PPLANS                ANS  (MINE)                     00322
         MVC   PPLCBUF(4),CPPLCBUF      CBUF (CPPL)                     00323
         LA    R5,MYUWA                                                 00324
         ST    R5,PPLUWA                UWA  (MINE)                     00325
         DROP  R6                       DROP ADDRESSABILITY             00326
*                                                                       00327
         LA    R6,MYIOPL                ADDRESS OF MY IO PARM LIST      00328
         USING IOPL,R6                    ADDRESSABILITY                00329
         MVC   IOPLUPT(4),CPPLUPT       UPT  (CPPL)                     00330
         MVC   IOPLECT(4),CPPLECT       ECT  (CPPL)                     00331
         LA    R15,MYIOECB                                              00332
         ST    R15,IOPLECB              ECB  (MINE)                     00333
         XC    IOPLIOPB(4),IOPLIOPB     IOPB (0000)                     00334
*                                                                       00335
         DROP  R4,R6                                                    00336
*                                                                       00337
PPEND    L     RBAL,PPRBALSV            RESTORE RETURN ADDRESS          00338
         BR    RBAL                     RETURN                          00339
         EJECT                                                          00340
**********************************************************************  00341
***                                                                ***  00342
***    PARSE THE INPUT PARAMETER STRING                            ***  00343
***                                                                ***  00344
***      1.  Execute IKJPARS with CALLTSSR using own PPL.          ***  00345
***      2.  Load address of Parm Descriptor Element List (PDL)    ***  00346
***          from own ANS word into R9 for addressability.         ***  00347
***                                                                ***  00348
**********************************************************************  00349
PARSE    ST    RBAL,PARBALSV            SAVE RETURN ADDRESS             00350
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00351
*                                                                       00352
         XC    MYECB,MYECB              ZERO THE ECB FOR PARSE          00353
PARSEIT  CALLTSSR EP=IKJPARS,MF=(E,MYPPL)  PARSE THE PARMS              00354
         L     R9,MYPPL+(PPLANS-PPL)    POINTER TO PDL ADDRESS          00355
         L     R9,0(0,R9)               ADDRESSABILITY OF PDL           00356
*                                                                       00357
PAEND    L     RBAL,PARBALSV            RESTORE RETURN ADDRESS          00358
         BR    RBAL                     RETURN                          00359
*                                                                       00360
         EJECT                                                          00361
**********************************************************************  00362
***                                                                ***  00363
***  LOCATE THE DATA AREAS                                         ***  00364
***                                                                ***  00365
**********************************************************************  00366
LOCATE   ST    RBAL,LORBALSV            SAVE RETURN ADDRESS             00367
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00368
*                                                                       00369
*                                                                       00370
LOPSA    XR    R15,R15                  ADDRESS OF PSA                  00371
         L     R15,(FLCCVT-PSA)(R15)    ADDRESS OF CVT                  00372
*                                                                       00373
LOSMCA   CLC   KEYSYSID,=H'2'           IF 'NOSYSID'                    00374
         BE    LOLTA                      SKIP THIS                     00375
         L     R8,(CVTSMCA-CVT)(R15)              ADDR OF SMF WORK AREA 00376
         MVC   LOSYSID(4),(SMCASID-SMCABASE)(R8)  SAVE THE SYSTEM ID    00377
*                                                                       00378
LOLTA    L     R8,(CVTLLTA-CVT)(R15)    ADDRESS OF LINKLIST TABLE       00379
         ST    R8,LOLLTA                SAVE IT                         00380
*                                                                       00381
         B     LOEND                                                    00382
*                                                                       00383
LORET04  LA    R15,X'04'                RETURN CODE TO R15              00384
         ST    R15,RETCDE               SAVE IT                         00385
         B     LOEND                    BRANCH TO ENDING                00386
*                                                                       00387
LOEND    L     RBAL,LORBALSV            RESTORE RETURN ADDRESS          00388
         BR    RBAL                     RETURN                          00389
*                                                                       00390
         EJECT                                                          00391
**********************************************************************  00392
***                                                                ***  00393
***  FORMAT AND WRITE THE MESSAGES                                 ***  00394
***                                                                ***  00395
**********************************************************************  00396
PRINT    ST    RBAL,PRRBALSV            SAVE RETURN ADDRESS             00397
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00398
*                                                                       00399
         LA    R15,0                    SET MESSAGE NUMBER 0 (BLANK)    00400
         BAL   RBAL,PUTLPROC            WRITE THE MESSAGE               00401
*                                                                       00402
PRSYSID  CLC   KEYSYSID,=H'2'           IF 'NOSYSID'                    00403
         BE    PRDSNS                     SKIP THIS                     00404
         MVC   MSG0001A(29),WRK0001A    INITIALIZE THE MESSAGE          00405
         MVC   MSG0001A+10(4),LOSYSID   ADD THE SYSID                   00406
         LA    R15,1                    SET MESSAGE NUMBER              00407
         BAL   RBAL,PUTLPROC            WRITE THE MESSAGE               00408
*                                                                       00409
PRDSNS   ICM   R2,15,LLTCOUNT           R2 HAS NUMBER OF DSNS           00410
         LA    R3,LLTDSN                POSITION TO FIRST DSNAME        00411
         S     R3,=F'45'                POSITION TO MINUS-1 DSNAME      00412
         ZAP   PRCOUNT,=PL2'-1'         SET COUNT TO MINUS-1            00413
PRLOOP1  LA    R3,45(0,R3)              POINT TO NEXT DSNAME            00414
         AP    PRCOUNT,=PL2'+1'         ADD ONE TO COUNT                00415
         MVC   MSG0002A(57),WRK0002A    INITIALIZE THE MESSAGE          00416
PRDSN1   MVC   MSG0002A+10(44),0(R3)    PUT THE DSN ONTO THE MESSAGE    00417
         CLC   KEYNUM(2),=H'2'          IF 'NONUM' IN USE               00418
         BE    PRDSN2                     BRANCH AROUND                 00419
         MVC   MSG0002A+04(4),EDMASK    SET THE EDIT MASK               00420
         ED    MSG0002A+04(4),PRCOUNT   EDIT THE NUMBER ONTO MESSAGE    00421
         B     PRPRINT                  BRANCH AROUND NONUM STUFF       00422
*                                                                       00423
PRDSN2   MVC   MSG0002A(57),WRK0002A    RE-INITIALIZE THE MESSAGE       00424
         MVC   MSG0002A+05(44),0(R3)    REPUT THE DSN ONTO THE MSG      00425
*                                                                       00426
PRPRINT  LA    R15,2                    SET MESSAGE NUMBER              00427
         BAL   RBAL,PUTLPROC            WRITE THE MESSAGE               00428
         BCT   R2,PRLOOP1               IF MORE, LOOP BACK UP           00429
*                                                                       00430
         LA    R15,0                    SET MESSAGE NUMBER 0 (BLANK)    00431
         BAL   RBAL,PUTLPROC            WRITE THE MESSAGE               00432
*                                                                       00433
         B     PREND                                                    00434
*                                                                       00435
PRRET04  LA    R15,X'04'                RETURN CODE TO R15              00436
         ST    R15,RETCDE               SAVE IT                         00437
         B     PREND                    BRANCH TO ENDING                00438
*                                                                       00439
PREND    L     RBAL,PRRBALSV            RESTORE RETURN ADDRESS          00440
         BR    RBAL                     RETURN                          00441
         EJECT                                                          00442
**********************************************************************  00443
***                                                                ***  00444
***   WRITE MESSAGE WITH PUTLINE                                   ***  00445
***                                                                ***  00446
***    1.  IOPL was initialized at beginning of program, IOPLIOPB  ***  00447
***        field will be filled in by PUTLINE execute macro.       ***  00448
***    2.  PTPB will be filled in by PUTLINE execute macro.        ***  00449
***    3.  OLD will be filled in by this procedure.                ***  00450
***                                                                ***  00451
***    Message number in R15 is multiplied by four and used as     ***  00452
***    offset into PUTABLE.  PUTABLE contains branch addresses     ***  00453
***    for processing appropriate message.                         ***  00454
**********************************************************************  00455
PUTLPROC ST    RBAL,PURBALSV            SAVE RETURN ADDRESS             00456
         XC    RETCDE,RETCDE            SET ERROR CODE TO ZERO          00457
*                                                                       00458
         SLL   R15,2                    R15 IS NOW OFFSET INTO PUTABLE  00459
         L     R15,PUTABLE(R15)         R15 NOW POINTS TO PROCESSING    00460
         BR    R15                      GO TO APPROPRIATE PROCESSING    00461
*                                                                       00462
PUTABLE  DC    A(PU0000)                PROCESS ADDR FOR BLANK LINE     00463
         DC    A(PU0001)                PROCESS ADDR FOR LST0001I       00464
         DC    A(PU0002)                PROCESS ADDR FOR LST0002I       00465
*                                                                       00466
PU0000   LA    R15,1(0,0)               SEGMENTS = 1                    00467
         ST    R15,MYOLD                  INTO O.L.D.                   00468
         LA    R15,MSG0000              ADDR OF BLANK LINE              00469
         ST    R15,MYOLD+4                INTO O.L.D.                   00470
         B     PUOUTPUT                 GO WRITE IT                     00471
*                                                                       00472
PU0001   LA    R15,1(0,0)               SEGMENTS = 1                    00473
         ST    R15,MYOLD                  INTO O.L.D.                   00474
         LA    R15,MSG0001A             ADDR OF LST0001I, SEG #1        00475
         ST    R15,MYOLD+4                INTO O.L.D.                   00476
         B     PUOUTPUT                 GO WRITE IT                     00477
*                                                                       00478
PU0002   LA    R15,1(0,0)               SEGMENTS = 1                    00479
         ST    R15,MYOLD                  INTO O.L.D.                   00480
         LA    R15,MSG0002A             ADDR OF LST0002I, SEG #1        00481
         ST    R15,MYOLD+4                INTO O.L.D.                   00482
         B     PUOUTPUT                 GO WRITE IT                     00483
*                                                                       00484
PUOUTPUT XC    MYPTPB(MYPTPBLN),MYPTPB  ZERO THE PUTLINE PARM BLOCK     00485
         XC    MYIOECB,MYIOECB          ZERO THE ECB                    00486
         PUTLINE PARM=MYPTPB,OUTPUT=MYOLD,MF=(E,MYIOPL)                 00487
         LTR   R15,R15                  IF RETURN IS ZERO               00488
         BZ    PUEND                      GO TO END                     00489
         B     PUERR04                  ELSE GO TO ERROR                00490
*                                                                       00491
PUERR04  LA    R15,X'04'(0,0)           SET VALUE                       00492
         ST    R15,RETCDE                 INTO INTERNAL RETURN CODE     00493
*                                                                       00494
PUEND    L     RBAL,PURBALSV            RESTORE RETURN ADDRESS          00495
         BR    RBAL                     RETURN                          00496
         EJECT                                                          00497
**********************************************************************  00498
***                                                                ***  00499
***   DATA CONSTANTS                                               ***  00500
***                                                                ***  00501
**********************************************************************  00502
CONSTDTA DS    0D                       AREA FOR DATA CONSTANTS         00503
VPARMPCL DC    V(PARMPCL)               ADDR OF PARM CONTROL LIST       00504
VESTXIT  DC    V(ESTXIT)                ADDR OF ABEND EXIT              00505
*                                                                       00506
F0       DC    F'0'                     CONSTANT                        00507
F12      DC    F'12'                    CONSTANT                        00508
BLANKS   DC    CL80' '                  BLANK LINE                      00509
*                              0....+....1....+....2....+....3....+     00510
MSG0000  DC    H'06',H'00',CL02'  '                                     00511
WRK0001A DC    H'29',H'00',CL25' ---- XXXX LINK LIST ----'              00512
WRK0002A DC    H'57',H'00',CL53' 000  DSNAME            '               00513
*                                                                       00514
EDMASK   DC    X'40202120'                                              00515
*                                                                       00516
ESTAED   ESTAE MF=L                                                     00517
*                                                                       00518
         LTORG                                                          00519
*                                                                       00520
CONSTEND DS    0D                                                       00521
CONSTLEN EQU   *-CONSTDTA               TOTAL LENGTH OF CONSTANTS       00522
*                                                                       00523
         EJECT                                                          00524
**********************************************************************  00525
***                                                                ***  00526
***    COMMAND OPERANDS                                            ***  00527
***                                                                ***  00528
***    See syntax description at beginning of program.             ***  00529
***                                                                ***  00530
**********************************************************************  00531
PARMPCL  IKJPARM  DSECT=PARMPDL                                         00532
*                                                                       00533
KEYSYSID IKJKEYWD DEFAULT='SYSID'                                       00534
         IKJNAME  'SYSID',ALIAS=('ID')                                  00535
         IKJNAME  'NOSYSID',ALIAS=('NOID')                              00536
*                                                                       00537
KEYNUM   IKJKEYWD DEFAULT='NUM'                                         00538
         IKJNAME  'NUM'                                                 00539
         IKJNAME  'NONUM'                                               00540
*                                                                       00541
         IKJENDP                                                        00542
*                                                                       00543
         EJECT                                                          00544
**********************************************************************  00545
***                                                                ***  00546
***   DATA AREA IN SUBPOOL 000                                     ***  00547
***                                                                ***  00548
**********************************************************************  00549
WORKD    DSECT                          AREA-13 FOR VARIABLES           00550
MYSAVE   DS    18F                      REGISTER SAVE AREA              00551
CPPLPTR  DS    F                        INITIAL VALUE OF R1 (CPPLADDR)  00552
RETCDE   DS    F                        INTERNAL RETURN CODE            00553
COMPCODE DS    F                        PROGRAM COMPLETION CODE         00554
*                                                                       00555
ABRBALSV DS    F                        RETURN ADDRESS SAVE AREA        00556
PPRBALSV DS    F                        RETURN ADDRESS SAVE AREA        00557
PARBALSV DS    F                        RETURN ADDRESS SAVE AREA        00558
PURBALSV DS    F                        RETURN ADDRESS SAVE AREA        00559
LORBALSV DS    F                        RETURN ADDRESS SAVE AREA        00560
PRRBALSV DS    F                        RETURN ADDRESS SAVE AREA        00561
*                                                                       00562
MYPPL    DS    7F                       PARSE PARAMETER LIST            00563
MYECB    DS    F                        ECB FOR PARSE                   00564
MYANS    DS    F                        POINTER TO THE PDL              00565
*                                                                       00566
MYUWA    DS    0D                       WORK/SAVE AREA FOR PARSE EXITS  00567
MYUWASV  DS    18F                      SAVE AREA FOR EXITS             00568
MYUWAWRK DS    14F                      WORK AREA FOR EXITS             00569
*                                                                       00570
MSG0001A DS    H,H,CL25                                                 00571
MSG0002A DS    H,H,CL53                                                 00572
*                                                                       00573
PRCOUNT  DS    PL2                      DSN COUNT                       00574
*                                                                       00575
MYIOPL   DS    4F                       IO PARM LIST                    00576
MYIOECB  DS    F                        ECB FOR I/O ROUTINES            00577
MYPTPB   PUTLINE MF=L                   PUTLINE PARM BLOCK (PTPB)       00578
MYPTPBLN EQU   *-MYPTPB                   LENGTH OF PTPB                00579
*                                       OUTPUT LINE DESCRIPTOR, 1 LEVEL 00580
MYOLD    DS    F                          NUMBER OF SEGMENTS            00581
         DS    5A                         ADDRS OF UP TO FIVE SEGMENTS  00582
*                                                                       00583
ESTAEL   ESTAE MF=L                                                     00584
ESTAELLN EQU   *-ESTAEL                                                 00585
ESTUPL   DS    0D                       ESTAE USER PARM LIST            00586
         DS    A                          ADDRESS OF RETURN POINT       00587
         DS    A                          ADDRESS OF USER WORK AREA     00588
ESTUWK   DS    0D                       ESTAE USER WORK AREA            00589
         DS    18F                        REGISTER SAVE AREA            00590
         DS    D                          DOUBLE WORD FOR UNPACK        00591
         DS    F                          BAL REGISTER SAVE AREA        00592
         WTO   '.+....1....+....2....+....3....+....4....+....5',      X00593
               ROUTCDE=(11),DESC=(7),MF=L                               00594
*                                                                       00595
LOLLTA   DS    A                        ADDRESS OF LINKLIST TABLE       00596
LOSYSID  DS    CL4                      SMF SYSTEM ID                   00597
*                                                                       00598
WORKDEND DS    0D                                                       00599
WORKDLEN EQU   *-WORKD                  TOTAL LENGTH OF WORK-13 AREA    00600
         EJECT                                                          00601
**********************************************************************  00602
***                                                                ***  00603
***   MAPPING DSECTS                                               ***  00604
***                                                                ***  00605
**********************************************************************  00606
*                                                                       00607
         CVT   DSECT=YES              , CVTMAP FOR IKJPARS              00608
         IKJCPPL                        COMMAND PROCESSOR PARM LIST     00609
         IKJPPL                         PARSE PARM LIST                 00610
         IKJIOPL                        I/O PARM LIST                   00611
*                                                                       00612
         IHASDWA                      , SDWA FOR ESTAE EXIT             00613
*                                                                       00614
         IHAPSA                         MAP OF PSA  DSECT=PSA           00615
         IEESMCA                        MAP OF SMCA DSECT=SMCABASE      00616
         IHALLT                         MAP OF LLT  DSECT=LLT           00617
*                                                                       00618
         EJECT                                                          00619
**********************************************************************  00620
***                                                                ***  00621
***   EQUATES                                                      ***  00622
***                                                                ***  00623
**********************************************************************  00624
RBASE    EQU   12                       BASE REGISTER                   00625
RBAL     EQU   10                       BAL REGISTER                    00626
*                                                                       00627
R0       EQU   0                                                        00628
R1       EQU   1                                                        00629
R2       EQU   2                                                        00630
R3       EQU   3                                                        00631
R4       EQU   4                                                        00632
R5       EQU   5                                                        00633
R6       EQU   6                                                        00634
R7       EQU   7                                                        00635
R8       EQU   8                                                        00636
R9       EQU   9                                                        00637
R10      EQU   10                                                       00638
R11      EQU   11                                                       00639
R12      EQU   12                                                       00640
R13      EQU   13                                                       00641
R14      EQU   14                                                       00642
R15      EQU   15                                                       00643
         EJECT                                                          00644
**********************************************************************  00645
***                  ESTAE (ABEND) EXIT                            ***  00646
***                                                                ***  00647
***   This exit will receive control from RTM during ABEND         ***  00648
***   processing.  Data areas available to this exit will be       ***  00649
***   the System Diagnostic Work Area (SDWA) provided by the       ***  00650
***   RTM, and the user parm list and the areas it points to       ***  00651
***   which are provided by the main routine.                      ***  00652
***                                                                ***  00653
***   This exit will format an ABEND message, and write it         ***  00654
***   with a WTO.  It will then return to RTM.                     ***  00655
***                                                                ***  00656
***   The register save area used by this exit has already been    ***  00657
***   obtained by a GETMAIN by the main program, prior to the      ***  00658
***   execution of the ESTAE macro.                                ***  00659
***                                                                ***  00660
***   This exit is entered by RTM with standard MVS linkage        ***  00661
***   conventions.  Upon entry, the following relationships        ***  00662
***   exist:                                                       ***  00663
***                                                                ***  00664
*** R1              SDWA (IHASDWA)   ESTUSRPL                      ***  00665
*** +-----------+   +------------+   +-----------+                 ***  00666
*** |           |==>| SDWAPARM   |==>| ESURETA   |==> Return point ***  00667
*** +-----------+   +------------+   +-----------+                 ***  00668
***                 | SDWAABCC   |   | ESUWRKA   |==> ESUWKD       ***  00669
***                 +------------+   +-----------+   +-----------+ ***  00670
***                 |            |                   | Save area | ***  00671
***                ---          ---                 ---         ---***  00672
***                ---          ---                 ---         ---***  00673
***                 |            |                   |           | ***  00674
***                 +------------+                   +-----------+ ***  00675
***                 | SDWAGR15   |                   | Other work| ***  00676
***                 +------------+                   |   areas   | ***  00677
***                 |            |                   +-----------+ ***  00678
***                ---          ---                                ***  00679
***                ---          ---                                ***  00680
***                 |            |                                 ***  00681
***                 +------------+                                 ***  00682
***                                                                ***  00683
**********************************************************************  00684
         EJECT                                                          00685
**********************************************************************  00686
***                                                                ***  00687
***          SEE DOCUMENTATION ON PREVIOUS PAGE                    ***  00688
***                                                                ***  00689
**********************************************************************  00690
ESTXIT   CSECT                                                          00691
         STM   R14,R12,12(R13)          SAVE REGS INTO CALLER'S S.A.    00692
         LR    R12,R15                  R12 HAS BASE ADDRESS            00693
         USING ESTXIT,R12                 ADDRESSABILITY                00694
         LR    R11,R1                   R11 POINTS TO SDWA              00695
         USING SDWA,R11                   ADDRESSABILITY                00696
         L     R10,SDWAPARM             R10 POINTS TO USER PARM LIST    00697
         USING ESTUSRPL,R10               ADDRESSABILITY                00698
         L     R15,ESUSRWKA             R15 POINTS TO USER WORK AREA    00699
         ST    R13,4(0,R15)             CALLER'S S.A. ADDR TO OWN S.A.  00700
         ST    R15,8(0,R13)             OWN S.A. ADDR TO CALLER'S S.A.  00701
         LR    R13,R15                  R13 POINTS TO OWN S.A.          00702
         USING ESUWKD,R13                 ADDRESSABILITY                00703
*                                                                       00704
ESTMESSG BAL   R9,ESMSG                 FORMAT AND WRITE A MESSAGE      00705
*                                                                       00706
         PRINT GEN                                                      00707
         L     R4,ESURETA               R4 CONTAINS RETURN ADDRESS      00708
ESTSETRP SETRP WKAREA=(R11),RC=4,RETADDR=(R4),RETREGS=YES,FRESDWA=YES   00709
         PRINT NOGEN                                                    00710
*                                                                       00711
ESTEND   XR    R15,R15                  CLEAR RETURN CODE               00712
         L     R13,4(0,R13)             RESTORE R13, PNT TO CALLER'S SA 00713
         LM    R0,R12,20(R13)           RESTORE R0-R12 FROM CALLER'S SA 00714
         L     R14,12(0,R13)            RESTORE R14 FROM CALLER'S S.A.  00715
         BR    R14                      RETURN                          00716
         EJECT                                                          00717
**********************************************************************  00718
***                                                                ***  00719
***                  WRITE ABEND MESSAGE                           ***  00720
***                                                                ***  00721
**********************************************************************  00722
ESMSG    ST    R9,ESUBALS1              SAVE BAL REGISTER               00723
*                                                                       00724
         MVC   WTOL(WTOLLEN),WTOD       INITIALIZE WTO PARM LIST        00725
*                                                                       00726
ESSYSCDE L     R3,SDWAABCC              R3 HAS ABEND CODES              00727
         SLL   R3,8                     LEFT JUSTIFY SYSTEM CODE        00728
         LA    R4,WTOL+26               R4 POINTS INTO MESSAGE          00729
         LA    R5,3                     R5 COUNTER SET TO 3             00730
         BAL   R9,ESHEX                 CONVERT TO DISPLAYABLE HEX      00731
*                                                                       00732
ESR15CDE L     R3,SDWAGR15              R3 HAS ABEND R15 CONTENTS       00733
         LA    R4,WTOL+42               R4 POINTS INTO MESSAGE          00734
         LA    R5,8                     R5 COUNTER SET TO 8             00735
         BAL   R9,ESHEX                 CONVERT TO DISPLAYABLE HEX      00736
*                                                                       00737
ESUSRCDE L     R3,SDWAABCC              R3 HAS ABEND CODES              00738
         N     R3,ESXFFF                R3 HAS ONLY USER CODE           00739
         CVD   R3,ESUWKDBL              CONVERT TO DECIMAL              00740
         OI    ESUWKDBL+7,X'0F'         KILL THE SIGN                   00741
         UNPK  WTOL+33(4),ESUWKDBL(8)   UNPACK INTO MESSAGE             00742
*                                                                       00743
ESWTO    WTO   MF=(E,WTOL)              WRITE THE MESSAGE               00744
*                                                                       00745
ESMSGEND L     R9,ESUBALS1              RESTORE THE BAL REGISTER        00746
         BR    R9                       RETURN                          00747
*                                                                       00748
*                                                                       00749
ESHEX    XR    R2,R2                    CLEAR EVEN REG OF EVEN/ODD      00750
         SLDL  R2,4                     R2 RECEIVES ONE HEX DIGIT       00751
         LA    R4,1(0,R4)               R4 POINTS TO NEXT MESSAGE CHAR  00752
         LA    R2,ESHEXTBL(R2)          R2 POINTS TO CHAR IN TABLE      00753
         MVC   0(1,R4),0(R2)            MOVE CHAR FROM TABLE TO MESSAGE 00754
         BCT   R5,ESHEX                 LOOP BACK UP                    00755
         BR    R9                       RETURN                          00756
*                                                                       00757
         EJECT                                                          00758
**********************************************************************  00759
***                                                                ***  00760
***          DATA AREAS AND DSECTS FOR ESTAE EXIT                  ***  00761
***                                                                ***  00762
**********************************************************************  00763
ESHEXTBL DC    CL16'0123456789ABCDEF'   TRANSLATE TABLE                 00764
         DS    0F                       ALIGN                           00765
ESXFFF   DC    X'00000FFF'              MASK TO CLEAR BITS 0-19         00766
WTOD     WTO   '*** ABEND ***  Codes: SXXX, U9999, R15=XXXXXXXX',      X00767
               ROUTCDE=(11),DESC=(7),MF=L                               00768
*                                                                       00769
*                                                                       00770
*                                                                       00771
ESTUSRPL DSECT                          USER PARM LIST                  00772
ESURETA  DS    A                          RETURN ADDRESS FOR RTM        00773
ESUSRWKA DS    A                          WORK AREA ADDRESS FOR ME      00774
*                                                                       00775
*                                                                       00776
*                                                                       00777
ESUWKD   DSECT                          USER WORK AREA                  00778
ESUWKSAV DS    18F                        REGISTER SAVE AREA            00779
ESUWKDBL DS    D                          DOUBLE WORD FOR UNPACK        00780
ESUBALS1 DS    F                          BAL REGISTER SAVE AREA        00781
WTOL     WTO   '.+....1....+....2....+....3....+....4....+....5',      X00782
               ROUTCDE=(11),DESC=(7),MF=L                               00783
WTOLLEN  EQU   *-WTOL                     LENGTH OF WTO PARM LIST       00784
*                                                                       00785
#PAN$AUD CSECT                                                          007854
$PAN#AUD DC    CL21'001CBT1791   12/20/87'                              007855
         END                                                            00786
